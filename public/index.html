<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF Mail Post Office</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Ferris CSS */
        .ferris-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: auto;
            z-index: 40;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .ferris-container:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .ferris-img {
            width: 100%;
            height: auto;
            display: block;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 2px 5px rgba(247, 76, 0, 0.3));
        }

        /* Optional cute wiggle on click or hover state */
        .ferris-container:active .ferris-img {
            transform: scale(0.95);
        }

        .speech-bubble {
            position: absolute;
            bottom: 60px;
            right: 0;
            background: #fff;
            border: 2px solid #F74C00;
            border-radius: 10px;
            padding: 8px;
            width: 180px;
            font-size: 12px;
            color: #333;
            box-shadow: 2px 2px 0 rgba(247, 76, 0, 0.2);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
            line-height: 1.4;
        }

        .speech-bubble.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .speech-bubble::after,
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 15px;
            /* Aligned to center of 50px crab */
            border-style: solid;
        }

        .speech-bubble::after {
            border-width: 10px 10px 0;
            border-color: #F74C00 transparent transparent transparent;
        }

        .speech-bubble::before {
            bottom: -7px;
            border-width: 8px 8px 0;
            border-color: #fff transparent transparent transparent;
            z-index: 1;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden" x-data="app()">

    <!-- Login Screen -->
    <div x-show="!isLoggedIn" x-cloak class="h-full flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-gray-200">
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4">
                    <i class="ph ph-envelope-simple text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">CF Mail Login</h1>
            </div>

            <form @submit.prevent="login">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" x-model="password"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        placeholder="Admin Password" required>
                </div>

                <div x-show="loginError" class="mb-4 text-red-500 text-sm text-center" x-text="loginError"></div>

                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg transition duration-200 flex items-center justify-center gap-2"
                    :disabled="isLoading">
                    <span x-show="!isLoading">Sign In</span>
                    <i x-show="isLoading" class="ph ph-spinner animate-spin text-xl"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div x-show="isLoggedIn" x-cloak class="h-full flex flex-col">

        <!-- Navbar -->
        <header
            class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 flex-shrink-0 z-10">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center">
                    <i class="ph ph-envelope-open text-lg"></i>
                </div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">CF Post Office</h1>
            </div>
            <div class="flex items-center gap-4">
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 flex overflow-hidden">

            <!-- Sidebar: Mailboxes -->
            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Mailboxes</h2>
                    <button @click="showCreateModal = true"
                        class="text-blue-600 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition"
                        title="New Mailbox">
                        <i class="ph ph-plus-circle text-xl"></i>
                    </button>
                </div>

                <!-- Search -->
                <div class="px-2 pt-2">
                    <div class="relative">
                        <i class="ph ph-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                        <input type="text" x-model="searchQuery" placeholder="Search..."
                            class="w-full pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="overflow-y-auto flex-1 p-2 space-y-1">
                    <template x-for="box in filteredMailboxes" :key="box.id">
                        <div @click="selectMailbox(box)"
                            class="group flex items-center justify-between p-2.5 rounded-lg cursor-pointer transition text-sm relative"
                            :class="selectedMailbox?.id === box.id ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'">

                            <div class="flex items-center gap-3 overflow-hidden">
                                <i class="ph text-lg"
                                    :class="selectedMailbox?.id === box.id ? 'ph-envelope-open text-blue-500' : 'ph-envelope text-gray-400'"></i>
                                <span class="truncate font-medium" x-text="box.address"></span>
                                <span x-show="box.is_auto_created" class="text-xs bg-orange-100 text-orange-600 px-1 rounded">Auto</span>
                            </div>

                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button @click.stop="copyToClipboard(box.address)"
                                    class="text-gray-400 hover:text-blue-500 p-1 rounded" title="Copy Address">
                                    <i class="ph ph-copy"></i>
                                </button>
                                <button @click.stop="deleteMailbox(box.id)"
                                    class="text-gray-400 hover:text-red-500 p-1 rounded" title="Delete Mailbox">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>
                    </template>

                    <div x-show="filteredMailboxes.length === 0 && !isLoading" class="text-center py-8 text-gray-400 text-sm">
                        <span x-show="searchQuery">No results</span>
                        <span x-show="!searchQuery">No mailboxes yet.</span>
                    </div>
                </div>
            </aside>

            <!-- Middle: Message List -->
            <div class="w-80 bg-white border-r border-gray-200 flex flex-col flex-shrink-0" x-show="selectedMailbox">
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50 h-[57px]">
                    <h3 class="font-semibold text-gray-800 truncate pr-2" x-text="selectedMailbox?.address"></h3>
                    <button @click="fetchMessages(selectedMailbox.id)"
                        class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-200 transition">
                        <i class="ph ph-arrow-clockwise text-lg" :class="{'animate-spin': isLoadingMessages}"></i>
                    </button>
                </div>

                <div class="overflow-y-auto flex-1">
                    <template x-for="msg in messages" :key="msg.id">
                        <div @click="selectMessage(msg.id)"
                            class="p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition"
                            :class="{'bg-blue-50/60': selectedMessage?.id === msg.id, 'bg-white': selectedMessage?.id !== msg.id}">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-semibold text-gray-900 text-sm truncate w-2/3"
                                    x-text="msg.sender || 'Unknown'"></span>
                                <span class="text-xs text-gray-500 whitespace-nowrap"
                                    x-text="formatDate(msg.received_at)"></span>
                            </div>
                            <div class="text-sm text-gray-800 font-medium truncate mb-1"
                                :class="{'text-gray-600 font-normal': msg.is_read}"
                                x-text="msg.subject || '(No Subject)'"></div>

                            <!-- Quick Copy Verification Code -->
                            <div x-show="msg.verification_code" class="flex items-center gap-2 mb-1">
                                <span
                                    class="bg-blue-100/50 text-blue-700 text-xs px-1.5 py-0.5 rounded font-mono font-bold border border-blue-100"
                                    x-text="msg.verification_code"></span>
                                <button @click.stop="copyToClipboard(msg.verification_code)"
                                    class="text-gray-400 hover:text-blue-600 p-0.5 rounded transition bg-white/50 hover:bg-white shadow-sm border border-transparent hover:border-gray-200"
                                    title="Copy Code">
                                    <i class="ph ph-copy"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 truncate" x-text="msg.preview || 'No preview available'">
                            </div>
                        </div>
                    </template>
                    <div x-show="messages.length === 0 && !isLoadingMessages"
                        class="text-center py-12 text-gray-400 text-sm px-6">
                        <div class="mb-2"><i class="ph ph-tray text-3xl"></i></div>
                        No messages in this mailbox.
                    </div>
                </div>
            </div>

            <!-- Empty State for Message List -->
            <div class="flex-1 flex items-center justify-center bg-gray-50 text-gray-400 flex-col"
                x-show="!selectedMailbox">
                <i class="ph ph-sidebar text-4xl mb-3"></i>
                <p>Select a mailbox to view messages</p>
            </div>

            <!-- Right: Message Detail -->
            <main class="flex-1 flex flex-col bg-white overflow-hidden relative" x-show="selectedMessage">
                <!-- Toolbar -->
                <div
                    class="h-[57px] border-b border-gray-200 flex items-center justify-between px-6 bg-white flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button @click="selectedMessage = null" class="lg:hidden text-gray-500 hover:text-gray-700">
                            <i class="ph ph-arrow-left text-xl"></i>
                        </button>
                        <div class="flex gap-2">
                            <!-- Actions could go here -->
                        </div>
                    </div>
                    <button @click="deleteMessage(selectedMessage.id)"
                        class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="ph ph-trash text-lg"></i> Delete
                    </button>
                </div>

                <!-- Reading Pane -->
                <div class="flex-1 overflow-y-auto" x-show="!isLoadingContent">
                    <div class="p-6 pb-2">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-900"
                                x-text="selectedMessage?.subject || '(No Subject)'"></h2>

                            <div x-show="selectedMessage?.verification_code"
                                class="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                                <span class="text-xs text-blue-600 font-semibold uppercase tracking-wider">Code:</span>
                                <span class="text-lg font-mono font-bold text-blue-700"
                                    x-text="selectedMessage?.verification_code"></span>
                                <button @click="copyToClipboard(selectedMessage?.verification_code)"
                                    class="ml-1 text-blue-400 hover:text-blue-600 transition" title="Copy Code">
                                    <i class="ph ph-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-start justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                                    <span x-text="(selectedMessage?.sender || '?')[0].toUpperCase()"></span>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">
                                        <span x-text="selectedMessage?.sender"></span>
                                    </div>
                                    <div class="text-xs text-gray-500"
                                        x-text="'To: ' + (selectedMessage?.mailbox_address || 'Me')"></div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500" x-text="formatFullDate(selectedMessage?.received_at)">
                            </div>
                        </div>

                        <!-- Attachments -->
                        <div x-show="selectedMessage?.attachments?.length > 0" class="flex flex-wrap gap-2 mb-6">
                            <template x-for="att in selectedMessage?.attachments" :key="att.id">
                                <div
                                    class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 border border-gray-200 rounded-lg text-sm text-gray-700">
                                    <i class="ph ph-paperclip"></i>
                                    <span x-text="att.filename" class="truncate max-w-[150px]"></span>
                                    <span class="text-xs text-gray-400" x-text="formatSize(att.size)"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="border-t border-gray-200">
                        <!-- Email Content Frame -->
                        <div class="w-full h-full min-h-[500px] bg-white">
                            <template x-if="selectedMessage">
                                <iframe class="w-full h-full min-h-[600px] border-none"
                                    :srcdoc="selectedMessage.html || '<pre class=\'p-4 font-sans whitespace-pre-wrap\'>' + (selectedMessage.text || 'No content') + '</pre>'"
                                    x-init="$watch('selectedMessage', () => { imagePreview = null })"
                                    @load="
                                        $el.style.height = $el.contentWindow.document.documentElement.scrollHeight + 'px';
                                        const imgs = $el.contentWindow.document.querySelectorAll('img');
                                        imgs.forEach(img => {
                                            img.style.cursor = 'zoom-in';
                                            img.onclick = (e) => {
                                                e.preventDefault();
                                                openImagePreview(img.src);
                                            };
                                        });
                                    "></iframe>
                            </template>
                        </div>
                    </div>

                    <!-- Raw EML Link -->
                    <div class="p-6 pt-2 text-right">
                        <a :href="'/api/messages/' + selectedMessage?.id + '/raw'" target="_blank"
                            class="text-xs text-blue-500 hover:underline">View Raw EML</a>
                    </div>
                </div>

                <div x-show="isLoadingContent" class="absolute inset-0 flex items-center justify-center bg-white z-20">
                    <i class="ph ph-spinner animate-spin text-3xl text-blue-500"></i>
                </div>
            </main>

            <!-- Empty State for Details -->
            <div class="flex-1 flex items-center justify-center bg-gray-50 text-gray-400 flex-col"
                x-show="selectedMailbox && !selectedMessage">
                <i class="ph ph-envelope-open text-4xl mb-3 opacity-50"></i>
                <p>Select a message to read</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <!-- Social Buttons (Dynamic Position) -->
    <div class="fixed transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)] z-50 flex gap-3 pointer-events-none"
        :class="isLoggedIn ? 'top-4 right-6 transform translate-x-0' : 'bottom-4 left-1/2 transform -translate-x-1/2'">
        <a href="https://github.com/lyon-le/cf-mail" target="_blank"
            class="pointer-events-auto bg-white/80 hover:bg-white backdrop-blur shadow-sm border border-gray-200 text-gray-700 hover:text-black px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-2 transition">
            <i class="ph ph-github-logo text-lg"></i> GitHub
        </a>
        <a href="https://linux.do/u/marre/summary" target="_blank"
            class="pointer-events-auto bg-white/80 hover:bg-white backdrop-blur shadow-sm border border-gray-200 text-gray-700 hover:text-blue-600 px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-2 transition">
            <i class="ph ph-linux-logo text-lg"></i> LinuxDO
        </a>
        <button @click="fetchSettings(); showSettingsModal = true" x-show="isLoggedIn" x-transition:enter="transition ease-out duration-300 delay-300"
            x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100"
            class="pointer-events-auto bg-white/80 hover:bg-white backdrop-blur shadow-sm border border-gray-200 text-gray-700 hover:text-blue-600 px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-2 transition">
            <i class="ph ph-gear text-lg"></i> Settings
        </button>
        <button @click="logout" x-show="isLoggedIn" x-transition:enter="transition ease-out duration-300 delay-300"
            x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100"
            class="pointer-events-auto bg-white/80 hover:bg-white backdrop-blur shadow-sm border border-gray-200 text-gray-700 hover:text-red-600 px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-2 transition">
            <i class="ph ph-sign-out text-lg"></i> Logout
        </button>
    </div>

    <!-- Interactive Ferris -->
    <div x-data="catComponent()" class="ferris-container" @click="speak">
        <div class="speech-bubble" :class="{ 'active': isSpeaking }">
            <span x-html="currentMessage"></span>
        </div>
        <img src="/ferris.png" alt="Ferris" class="ferris-img">
    </div>

    <!-- Create Mailbox Modal -->
    <div x-show="showCreateModal" x-cloak
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div @click.outside="showCreateModal = false"
            class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Create New Mailbox</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Address (Optional)</label>
                    <div class="flex">
                        <input type="text" x-model="newMailboxAddress" placeholder="e.g. support"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-1 focus:ring-blue-500 outline-none text-sm">
                        <div class="relative">
                            <select x-model="selectedDomain"
                                class="appearance-none bg-gray-100 border border-l-0 border-gray-300 px-3 py-2 pr-8 text-sm text-gray-500 rounded-r-lg h-full outline-none focus:ring-0 cursor-pointer">
                                <template x-for="domain in availableDomains" :key="domain">
                                    <option :value="domain" x-text="'@' + domain"></option>
                                </template>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="ph ph-caret-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Leave empty to generate a random address.</p>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showCreateModal = false"
                        class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">Cancel</button>
                    <button @click="createMailbox"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition relative">
                        <span x-show="!isCreating">Create</span>
                        <span x-show="isCreating"><i class="ph ph-spinner animate-spin"></i></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettingsModal" x-cloak
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div @click.outside="showSettingsModal = false"
            class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Settings</h3>

            <div class="space-y-4">
                <!-- Auto Create Toggle -->
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Auto Create Mailbox</label>
                    <button @click="settings.auto_create_enabled = settings.auto_create_enabled === 'true' ? 'false' : 'true'"
                        class="relative w-12 h-6 rounded-full transition"
                        :class="settings.auto_create_enabled === 'true' ? 'bg-blue-600' : 'bg-gray-300'">
                        <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"
                            :class="settings.auto_create_enabled === 'true' ? 'translate-x-6' : ''"></span>
                    </button>
                </div>

                <!-- Min Length -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Min Length</label>
                    <input type="number" x-model="settings.auto_create_min_length" min="1" max="50"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <!-- Max Length -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Length</label>
                    <input type="number" x-model="settings.auto_create_max_length" min="1" max="50"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <!-- Start Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Allowed Start Character</label>
                    <select x-model="settings.auto_create_start_type"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="both">Letter or Digit</option>
                        <option value="letter">Letter Only</option>
                        <option value="digit">Digit Only</option>
                    </select>
                </div>

                <!-- Telegram Settings -->
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-800">Telegram Notification</h4>
                        <button @click="tgEnabled = !tgEnabled"
                            class="relative w-12 h-6 rounded-full transition"
                            :class="tgEnabled ? 'bg-blue-600' : 'bg-gray-300'">
                            <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"
                                :class="tgEnabled ? 'translate-x-6' : ''"></span>
                        </button>
                    </div>
                    <div x-show="tgEnabled" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bot Token <span class="text-red-500">*</span></label>
                            <input type="password" x-model="settings.tg_bot_token" placeholder="123456:ABC-DEF..." required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Chat ID <span class="text-red-500">*</span></label>
                            <div class="flex gap-2">
                                <input type="text" x-model="settings.tg_chat_id" placeholder="-1001234567890" required
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                <button type="button" @click="fetchChatId" :disabled="!settings.tg_bot_token || fetchingChatId"
                                    class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!fetchingChatId">获取</span>
                                    <span x-show="fetchingChatId">...</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Topic ID <span class="text-gray-400 text-xs">(可选)</span></label>
                            <input type="text" x-model="settings.tg_topic_id" placeholder="123"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Delete Auto Created -->
                <div class="pt-4 border-t border-gray-200">
                    <button @click="deleteAutoCreatedMailboxes"
                        class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-2">
                        <i class="ph ph-trash"></i> Delete All Auto-Created Mailboxes
                    </button>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showSettingsModal = false"
                        class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">Cancel</button>
                    <button @click="saveSettings"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div x-show="imagePreview" x-cloak
        class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center"
        @click.self="imagePreview = null"
        @keydown.escape.window="imagePreview = null">
        <div class="relative select-none"
            :style="`transform: translate(${imagePos.x}px, ${imagePos.y}px)`"
            @mousedown="startDrag($event)"
            @mousemove.window="onDrag($event)"
            @mouseup.window="stopDrag()"
            @mouseleave.window="stopDrag()">
            <button @click="imagePreview = null"
                class="absolute -top-3 -right-3 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-red-500 z-10">
                <i class="ph ph-x text-lg"></i>
            </button>
            <img :src="imagePreview" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl cursor-move">
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false,
                password: '',
                loginError: '',
                isLoading: false,
                mailboxes: [],
                searchQuery: '',
                messages: [],
                selectedMailbox: null,
                selectedMessage: null,
                // 图片预览
                imagePreview: null,
                imagePos: { x: 0, y: 0 },
                imageDragging: false,
                dragStart: { x: 0, y: 0 },
                isLoadingMessages: false,
                isLoadingContent: false,
                isLoadingContent: false,
                showCreateModal: false,
                newMailboxAddress: '',
                isCreating: false,
                availableDomains: [],
                selectedDomain: '',
                showSettingsModal: false,
                settings: {
                    auto_create_enabled: 'false',
                    auto_create_min_length: '6',
                    auto_create_max_length: '20',
                    auto_create_start_type: 'both',
                    tg_bot_token: '',
                    tg_chat_id: '',
                    tg_topic_id: ''
                },
                tgEnabled: false,
                fetchingChatId: false,

                get filteredMailboxes() {
                    if (!this.searchQuery.trim()) return this.mailboxes;
                    const q = this.searchQuery.toLowerCase();
                    return this.mailboxes.filter(box => box.address.toLowerCase().includes(q));
                },

                async init() {
                    // Check auth status by trying to fetch mailboxes (or check cookie existence if we could, but HTTPOnly)
                    // We'll just try to fetch mailboxes, if 401 then not logged in.
                    await this.fetchConfig();
                    await this.checkAuth();
                },

                async fetchConfig() {
                    try {
                        const res = await fetch('/api/config');
                        if (res.ok) {
                            const data = await res.json();
                            this.availableDomains = data.domains || [];
                            if (this.availableDomains.length > 0) {
                                this.selectedDomain = this.availableDomains[0];
                            }
                        }
                    } catch (e) {
                        console.error("Failed to fetch config", e);
                    }
                },

                async checkAuth() {
                    try {
                        const res = await fetch('/api/mailboxes');
                        if (res.ok) {
                            this.isLoggedIn = true;
                            const data = await res.json();
                            this.mailboxes = data.mailboxes;
                        } else if (res.status === 401) {
                            this.isLoggedIn = false;
                        }
                    } catch (e) {
                        console.error("Auth check failed", e);
                        this.isLoggedIn = false;
                    }
                },

                async login() {
                    this.isLoading = true;
                    this.loginError = '';
                    try {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.password })
                        });
                        const data = await res.json();

                        if (res.ok) {
                            this.isLoggedIn = true;
                            this.password = '';
                            this.fetchMailboxes();
                        } else {
                            this.loginError = data.error || 'Login failed';
                        }
                    } catch (e) {
                        this.loginError = 'Network error';
                    } finally {
                        this.isLoading = false;
                    }
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    this.isLoggedIn = false;
                    this.mailboxes = [];
                    this.selectedMailbox = null;
                    this.messages = [];
                    this.selectedMessage = null;
                },

                async fetchMailboxes() {
                    const res = await fetch('/api/mailboxes');
                    if (res.ok) {
                        const data = await res.json();
                        this.mailboxes = data.mailboxes;
                    }
                },

                async createMailbox() {
                    this.isCreating = true;
                    try {
                        const payload = this.newMailboxAddress ? { address: this.newMailboxAddress, domain: this.selectedDomain } : { domain: this.selectedDomain };
                        const res = await fetch('/api/mailboxes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            await this.fetchMailboxes();
                            this.showCreateModal = false;
                            this.newMailboxAddress = '';
                        } else {
                            const data = await res.json();
                            alert(data.error || 'Failed to create mailbox');
                        }
                    } catch (e) {
                        alert('Error creating mailbox');
                    } finally {
                        this.isCreating = false;
                    }
                },

                async deleteMailbox(id) {
                    if (!confirm('Are you sure? All messages in this mailbox will be deleted.')) return;

                    const res = await fetch(`/api/mailboxes/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        if (this.selectedMailbox?.id === id) {
                            this.selectedMailbox = null;
                            this.messages = [];
                            this.selectedMessage = null;
                        }
                        await this.fetchMailboxes();
                    }
                },

                async selectMailbox(box) {
                    this.selectedMailbox = box;
                    this.selectedMessage = null;
                    await this.fetchMessages(box.id);
                },

                async fetchMessages(mailboxId) {
                    this.isLoadingMessages = true;
                    this.messages = []; // Clear while loading
                    try {
                        const res = await fetch(`/api/mailboxes/${mailboxId}/messages`);
                        if (res.ok) {
                            const data = await res.json();
                            this.messages = data.messages;
                        }
                    } finally {
                        this.isLoadingMessages = false;
                    }
                },

                async selectMessage(id) {
                    // Update UI immediately for selection state
                    // Fetch full details
                    this.isLoadingContent = true;
                    this.selectedMessage = { id }; // Placeholder
                    try {
                        const res = await fetch(`/api/messages/${id}`);
                        if (res.ok) {
                            const data = await res.json();
                            this.selectedMessage = data.message;

                            // Mark local message as read
                            const msgIndex = this.messages.findIndex(m => m.id === id);
                            if (msgIndex !== -1) {
                                this.messages[msgIndex].is_read = 1;
                            }
                        }
                    } finally {
                        this.isLoadingContent = false;
                    }
                },

                async deleteMessage(id) {
                    if (!confirm('Delete this message?')) return;

                    const res = await fetch(`/api/messages/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        this.selectedMessage = null;
                        await this.fetchMessages(this.selectedMailbox.id);
                    }
                },

                formatDate(isoString) {
                    if (!isoString) return '';
                    const date = new Date(isoString);
                    // If today, show time, else show date
                    const now = new Date();
                    if (date.toDateString() === now.toDateString()) {
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    return date.toLocaleDateString();
                },

                formatFullDate(isoString) {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleString();
                },

                formatSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                async copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        // Optional: show a toast or change icon briefly
                        // We'll use a simple alert-like UI or just rely on console for now if no toast system,
                        // but actually let's just log it or maybe a temporary visual indicator would be better.
                        // For simplicity in this step, we can assume it works if no error.
                        // Let's create a temporary tooltip or just a simple alert for now?
                        // Actually, I'll add a 'showToast' variable and method to make it nice.
                        this.showToast('Copied to clipboard');
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                    }
                },

                showToast(message) {
                    // Create toast element dynamically
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm animate-bounce';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                },

                async fetchSettings() {
                    try {
                        const res = await fetch('/api/settings');
                        if (res.ok) {
                            const data = await res.json();
                            this.settings = { ...this.settings, ...data.settings };
                            this.tgEnabled = !!(this.settings.tg_bot_token && this.settings.tg_chat_id);
                        }
                    } catch (e) {
                        console.error('Failed to fetch settings', e);
                    }
                },

                async saveSettings() {
                    try {
                        const data = { ...this.settings };
                        if (!this.tgEnabled) {
                            data.tg_bot_token = '';
                            data.tg_chat_id = '';
                            data.tg_topic_id = '';
                        }
                        const res = await fetch('/api/settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (res.ok) {
                            this.showToast('Settings saved');
                            this.showSettingsModal = false;
                        }
                    } catch (e) {
                        alert('Failed to save settings');
                    }
                },

                async deleteAutoCreatedMailboxes() {
                    if (!confirm('Delete all auto-created mailboxes?')) return;
                    const res = await fetch('/api/mailboxes-auto-created', { method: 'DELETE' });
                    if (res.ok) {
                        const data = await res.json();
                        this.showToast(`Deleted ${data.deleted} mailboxes`);
                        await this.fetchMailboxes();
                        this.selectedMailbox = null;
                        this.messages = [];
                        this.selectedMessage = null;
                    }
                },

                async fetchChatId() {
                    if (!this.settings.tg_bot_token) return;
                    this.fetchingChatId = true;
                    try {
                        const res = await fetch(`https://api.telegram.org/bot${this.settings.tg_bot_token}/getUpdates`);
                        const data = await res.json();
                        if (!data.ok) {
                            alert(data.description || 'Token 无效');
                            return;
                        }
                        const lastMsg = data.result?.filter(u => u.message).pop();
                        if (!lastMsg?.message) {
                            alert('请先向 Bot 发送一条消息');
                            return;
                        }
                        this.settings.tg_chat_id = String(lastMsg.message.chat.id);
                        this.showToast('Chat ID 获取成功');
                    } catch (e) {
                        alert('获取失败');
                    } finally {
                        this.fetchingChatId = false;
                    }
                },

                // 图片拖动
                startDrag(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                    this.imageDragging = true;
                    this.dragStart = { x: e.clientX - this.imagePos.x, y: e.clientY - this.imagePos.y };
                },
                onDrag(e) {
                    if (!this.imageDragging) return;
                    this.imagePos = { x: e.clientX - this.dragStart.x, y: e.clientY - this.dragStart.y };
                },
                stopDrag() {
                    this.imageDragging = false;
                },
                openImagePreview(src) {
                    this.imagePreview = src;
                    this.imagePos = { x: 0, y: 0 };
                }
            }
        }

        function catComponent() {
            return {
                isSpeaking: false,
                currentMessage: '',
                timeout: null,

                speak() {
                    // Clear existing timeout
                    if (this.timeout) clearTimeout(this.timeout);

                    // Scenarios
                    const scenarios = [
                        // 1. Stars
                        () => `也许你可以突然给我一个 <a href="https://github.com/lyon-le/cf-mail" target="_blank" class="text-blue-500 underline font-bold">Stars</a> 呢`,
                        // 2. No TS
                        () => `你知道的, 我不会写TypeScript, 因为我是一只螃蟹？`,
                        // 3. Password
                        () => `你的密码太简单了，要改吗？`,
                        () => `我本来想用Rust写的,但是CF这个傻福没给Rust做完方法`,
                        // 4. Domain Joke
                        () => {
                            // Try to get a domain from the app component if possible, 
                            // but we are in a different scope. We can direct access global but alpine scope is cleaner.
                            // Let's rely on a global way or just mock if empty, 
                            // but actually we can access the 'availableDomains' from the x-data="app()" if we dispatch event or similar.
                            // Simpler: Just random if no access, or try to read typical list.
                            // But better: Let's assume we can peak at text content or just random common ones if 'availableDomains' isn't easily reachable without event bus.
                            // ACTUALLY: DOM access is easy.
                            const select = document.querySelector('select'); // The domain select
                            let domain = 'This';
                            if (select && select.options.length > 0) {
                                const randomIndex = Math.floor(Math.random() * select.options.length);
                                domain = select.options[randomIndex].value;
                            } else {
                                domain = 'cf-mail.com';
                            }
                            return `${domain} 这个域名在我这里可以买一顿疯狂星期四了`;
                        }
                    ];

                    // Pick random
                    const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                    this.currentMessage = randomScenario();

                    this.isSpeaking = true;
                    this.timeout = setTimeout(() => {
                        this.isSpeaking = false;
                    }, 4000);
                }
            }
        }
    </script>
</body>

</html>